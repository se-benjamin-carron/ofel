name: Test campaigns

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        campaign: [unit, integration, performance]
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'
      - name: Restore
        run: dotnet restore
      - name: Build
        run: dotnet build --no-restore --configuration Release
      - name: Run tests (${{ matrix.campaign }})
        run: |
          if [ "${{ matrix.campaign }}" = "unit" ]; then
            dotnet test tests/Ofel.Tests/Ofel.Tests.csproj --no-build --filter "Category=Unit" --logger "trx;LogFileName=test-unit.trx"
          elif [ "${{ matrix.campaign }}" = "integration" ]; then
            dotnet test tests/Ofel.Tests/Ofel.Tests.csproj --no-build --filter "Category=Integration" --logger "trx;LogFileName=test-integration.trx"
          else
            dotnet run -c Release -p tests/Ofel.PerfTests/Ofel.PerfTests.csproj
          fi
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.campaign }}
          path: "*.trx"
